C51 COMPILER V9.53.0.0   PID                                                               09/16/2016 10:06:32 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE PID
OBJECT MODULE PLACED IN .\src\PID.OBJ
COMPILER INVOKED BY: c:\SiliconLabs\SimplicityStudio\v3\developer\toolchains\keil_8051\9.53\BIN\C51.exe C:\Users\clfilho
                    -\SimplicityStudio\v3_workspace\myProject - DAC Enabled\src\PID.c OMF2 SMALL DEBUG OBJECTEXTEND ROM(LARGE) WARNINGLEVEL(2
                    -) FLOATFUZZY(3) OPTIMIZE(8,SPEED) INTVECTOR(0X0000) INTPROMOTE INCDIR(C:/Users/clfilho/SimplicityStudio/v3_workspace/myP
                    -roject - DAC Enabled/inc;C:/SiliconLabs/SimplicityStudio/v3/developer/sdks/si8051/v3//Device/shared/si8051Base;C:/Silico
                    -nLabs/SimplicityStudio/v3/developer/sdks/si8051/v3//Device/EFM8BB3;C:/SiliconLabs/SimplicityStudio/v3/developer/sdks/si8
                    -051/v3//Device/EFM8BB3/inc) PRINT(.\src\PID.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src\PID.OBJ)

line level    source

   1          //-----------------------------------------------------------------------------
   2          // PID.c
   3          //-----------------------------------------------------------------------------
   4          // Copyright 2016, Silicon Laboratories, Inc.
   5          // http://www.silabs.com
   6          //
   7          // Created on: Sept 2016
   8          //     Author: Claudio Filho
   9          //
  10          // PID controller for EFM8
  11          //
  12          //-----------------------------------------------------------------------------
  13          
  14          #include <SI_EFM8BB3_Register_Enums.h>
  15          #include "PID.h"
  16          
  17          
  18          //Constants for the PID Controller
  19          
  20          //Error Limits
  21          #define errorlimitH 50
  22          #define errorlimitL -50
  23          
  24          //PID Output Limit
  25          #define PIDOutlimitH 4095
  26          
  27          //System Set point
  28          #define OutputSetPoint  4096
  29          
  30          //PID Multiplying Factors
  31          #define Kp 0x0003
  32          #define Ki 0x00101
  33          #define Kd 0x01000
  34          
  35          
  36          //Static Variables
  37          
  38          static xdata int16_t Error;
  39          static xdata int16_t Error_Integral;
  40          static xdata int16_t Error_Derivative;
  41          static xdata  int16_t Previous_Error =0;
  42          static xdata  int16_t P_term;
  43          static xdata  int16_t I_term;
  44          static xdata  int16_t D_term;
  45          static xdata  int16_t PIDresult;
  46          
  47          static xdata uint16_t ADCResult;
  48          static xdata uint16_t OutputResult;
  49          
  50          
  51          
C51 COMPILER V9.53.0.0   PID                                                               09/16/2016 10:06:32 PAGE 2   

  52          uint16_t CalculatePID(uint16_t current_ADC)
  53          {
  54   1              //Scale goes from 0 to 4095
  55   1      
  56   1      
  57   1              Error = OutputSetPoint - current_ADC;
  58   1      
  59   1      
  60   1              Error_Integral = Error_Integral + Error;
  61   1      
  62   1              if(Error_Integral > errorlimitH)
  63   1                              {
  64   2                                      Error_Integral = errorlimitH;
  65   2                              }
  66   1      
  67   1              else if(Error_Integral < errorlimitL)
  68   1                      {
  69   2                              Error_Integral = errorlimitL;
  70   2                      }
  71   1      
  72   1              Error_Derivative = Error - Previous_Error;
  73   1              Previous_Error = Error;
  74   1      
  75   1              PIDresult = (Kp*Error) + (Ki*Error_Integral) + (Kd*Error_Derivative);
  76   1      
  77   1      
  78   1              PIDresult = PIDresult>>2;
  79   1      
  80   1              if(PIDresult >= PIDOutlimitH)
  81   1              {
  82   2                      PIDresult = PIDOutlimitH;
  83   2              }
  84   1      
  85   1              if(PIDresult < 0) {PIDresult = 0;}
  86   1      
  87   1              //PIDresult = ADCResult;
  88   1      
  89   1              return PIDresult;
  90   1      }
  91          
  92          void SetDACOutput(uint16_t value)
  93          {
  94   1      
  95   1              SFRPAGE = 0x30;
  96   1              DAC0H = value >>8;
  97   1              DAC0L= (char) value;
  98   1      }
  99          
 100          void GetADC(uint16_t value)
 101          {
 102   1              ADCResult = value>>4; //Dividing by 16 to get the averaged value
 103   1      }
 104          
 105          void PIDHandler()
 106          {
 107   1      
 108   1              OutputResult = CalculatePID(ADCResult);
 109   1      
 110   1      }
 111          
 112          
 113          void DACOutputHandler()
 114          {
C51 COMPILER V9.53.0.0   PID                                                               09/16/2016 10:06:32 PAGE 3   

 115   1              SetDACOutput(OutputResult);
 116   1              //SetDACOutput(ADCResult);
 117   1      }
 118          
 119          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    307    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     20    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
